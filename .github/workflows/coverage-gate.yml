name: Coverage Gate

on:
  pull_request:
    branches: [main]

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: web
        run: bun install

      - name: Run tests with coverage
        working-directory: web
        run: bun run test -- --coverage || true

      - name: Enforce 80% coverage on new / changed files
        run: |
          SUMMARY="web/coverage/coverage-summary.json"
          if [ ! -f "$SUMMARY" ]; then
            echo "::error::coverage-summary.json not found — tests may have crashed."
            exit 1
          fi

          # Absolute path prefix used by Istanbul in the JSON keys
          ABS_PREFIX="$(pwd)/web/"

          # Source files added or modified in this PR (relative to repo root, under web/)
          CHANGED=$(git diff --name-only --diff-filter=ACM origin/main...HEAD -- web/server/ web/src/ \
            | grep -E '\.(ts|tsx)$' \
            | grep -v '\.test\.\|\.spec\.\|__mocks__\|test-setup\|session-types\.ts\|src/types\.ts' || true)

          if [ -z "$CHANGED" ]; then
            echo "No new/changed source files in this PR — nothing to gate."
            exit 0
          fi

          echo "=== Changed source files ==="
          echo "$CHANGED"
          echo ""

          FAIL=0
          THRESHOLD=80

          for file in $CHANGED; do
            # Build the absolute path key that Istanbul uses in json-summary
            # $file is like "web/server/foo.ts", key is "/abs/path/web/server/foo.ts"
            ABS_KEY="$(pwd)/${file}"

            # jq: look up by absolute path
            LINES_PCT=$(jq -r --arg f "$ABS_KEY" '.[$f].lines.pct // empty' "$SUMMARY")

            # Strip "web/" prefix for display
            DISPLAY="${file#web/}"

            if [ -z "$LINES_PCT" ]; then
              echo "⚠️  $DISPLAY — no coverage data (not imported by any test)"
              echo "❌ $DISPLAY — treated as 0% (below ${THRESHOLD}%)"
              FAIL=1
              continue
            fi

            # Compare as float
            BELOW=$(awk "BEGIN { print ($LINES_PCT < $THRESHOLD) ? 1 : 0 }")
            if [ "$BELOW" = "1" ]; then
              echo "❌ $DISPLAY — ${LINES_PCT}% lines covered (threshold: ${THRESHOLD}%)"
              FAIL=1
            else
              echo "✅ $DISPLAY — ${LINES_PCT}% lines covered"
            fi
          done

          echo ""
          if [ "$FAIL" = "1" ]; then
            echo "::error::Coverage gate failed — one or more changed files are below ${THRESHOLD}% line coverage."
            echo "Add tests for the files listed above to bring them above the threshold."
            exit 1
          else
            echo "All changed files meet the ${THRESHOLD}% line coverage threshold."
          fi
